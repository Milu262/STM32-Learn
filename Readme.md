# STM32 ä¸ PC å·¥å…·é€šä¿¡åè®®è§„èŒƒï¼ˆHDLC å°è£…ï¼‰ 

> **ç›®çš„**ï¼šPC ç«¯å·¥å…·é€šè¿‡ä¸²å£å‘ STM32 å‘é€å‘½ä»¤ï¼ŒSTM32 æ‰§è¡Œæ“ä½œå¹¶è¿”å›ç»“æœã€‚  
> **åº•å±‚å°è£…**ï¼šä½¿ç”¨ HDLC-like å¸§æ ¼å¼ï¼ˆåŸºäº `0x7E` æ ‡å¿—ä½ï¼‰ï¼Œæ”¯æŒè½¬ä¹‰ã€CRC16 æ ¡éªŒã€‚
---

## ä¸€ã€å¸§ç»“æ„ï¼ˆHDLC å°è£…ï¼‰

**æ‰€æœ‰å‘½ä»¤å’Œå“åº”éƒ½å¿…é¡»æŒ‰å¦‚ä¸‹æ ¼å¼å°è£…ï¼š**
###### HDLC å¸§ç»“æ„ï¼ˆå­—èŠ‚å¸ƒå±€ï¼‰

| å­—æ®µ                | é•¿åº¦ï¼ˆå­—èŠ‚ï¼‰ | è¯´æ˜                                              |
| ----------------- | ------ | ----------------------------------------------- |
| `FLAG_START`      | 1      | èµ·å§‹æ ‡å¿—ï¼šå›ºå®šä¸ºÂ `0x7E`                                 |
| `CMD_ID +Payload` | â‰¥2     | å‘½ä»¤ IDï¼ˆ2 å­—èŠ‚ï¼Œå¤§ç«¯åºï¼‰ + æœ‰æ•ˆè½½è·ï¼ˆ0 æˆ–æ›´å¤šå­—èŠ‚ï¼‰                 |
| `CRC16`           | 2      | å¯¹Â `[CMD_ID + Payload]`Â è®¡ç®—çš„ CRC16-CCITT æ ¡éªŒå€¼ï¼ˆå¤§ç«¯åºï¼‰ |
| `FLAG_END`        | 1      | ç»“æŸæ ‡å¿—ï¼šå›ºå®šä¸ºÂ `0x7E`                                 |

> ğŸ”” **æ€»å¸§é•¿åº¦** = 1ï¼ˆèµ·å§‹ï¼‰ + Nï¼ˆâ‰¥2ï¼‰ + 2ï¼ˆCRCï¼‰ + 1ï¼ˆç»“æŸï¼‰ = **è‡³å°‘ 6 å­—èŠ‚**

- **CMD_ID**ï¼š2 å­—èŠ‚ï¼Œå¤§ç«¯åºï¼ˆBig-Endianï¼‰
- **Payload**ï¼šå‘½ä»¤å‚æ•°æˆ–è¿”å›æ•°æ®
- **CRC16**ï¼šå¯¹ `[CMD_ID + Payload]` è®¡ç®— CRC16-CCITTï¼ˆåˆå§‹å€¼ `0xFFFF`ï¼Œå¤šé¡¹å¼ `0x1021`ï¼‰
- *==**ç‰¹æ®Šå­—èŠ‚è½¬ä¹‰**ï¼š==*
  - *==è‹¥æ•°æ®ä¸­å‡ºç° `0x7E` â†’ è½¬ä¹‰ä¸º `0x7D 0x5E`==*
  - *==è‹¥æ•°æ®ä¸­å‡ºç° `0x7D` â†’ è½¬ä¹‰ä¸º `0x7D 0x5D`==*
  - *==æ¥æ”¶ç«¯éœ€åå‘è§£ç ==*

> âœ… **ç¤ºä¾‹**ï¼šå‘é€å‘½ä»¤ `CMD_FLASH_READ = 0x0101`ï¼Œæ— å‚æ•°  
> åŸå§‹å¸§å†…å®¹ï¼š`[0x01, 0x01]`  
> CRC16(0x0101) = `0x1234`ï¼ˆå‡è®¾ï¼‰  
> å®é™…å‘é€ï¼š`7E 01 01 12 34 7E`

---

## äºŒã€å‘½ä»¤åˆ—è¡¨ï¼ˆPC â†’ STM32ï¼‰

| CMD_ID (Hex) | å‘½ä»¤åç§°                | Payload (è¯·æ±‚å‚æ•°)              | åŠŸèƒ½è¯´æ˜          |
| ------------ | ------------------- | --------------------------- | ------------- |
| `0x0101`     | `CMD_FLASH_READ`    | `4å­—èŠ‚èµ·å§‹åœ°å€ + 2å­—èŠ‚é•¿åº¦`           | è¯»å–å†…éƒ¨ Flash æ•°æ® |
| `0x0201`     | `CMD_I2C_READ_REG`  | `1å­—èŠ‚è®¾å¤‡åœ°å€ + 1å­—èŠ‚å¯„å­˜å™¨åœ°å€`        | I2C è¯»å•å­—èŠ‚å¯„å­˜å™¨   |
| `0x0202`     | `CMD_I2C_WRITE_REG` | `1å­—èŠ‚è®¾å¤‡åœ°å€ + 1å­—èŠ‚å¯„å­˜å™¨åœ°å€ + 1å­—èŠ‚å€¼` | I2C å†™å•å­—èŠ‚å¯„å­˜å™¨   |
| `0x0301`     | `CMD_SPI_READ_REG`  | `1å­—èŠ‚å¯„å­˜å™¨åœ°å€`                  | SPI è¯»å•å­—èŠ‚å¯„å­˜å™¨   |
| `0x0302`     | `CMD_SPI_WRITE_REG` | `1å­—èŠ‚å¯„å­˜å™¨åœ°å€ + 1å­—èŠ‚å€¼`           | SPI å†™å•å­—èŠ‚å¯„å­˜å™¨   |

> ğŸ’¡ æ‰€æœ‰åœ°å€/æ•°å€¼å‡ä½¿ç”¨ **å¤§ç«¯åºï¼ˆBig-Endianï¼‰**

---

## ä¸‰ã€å“åº”æ ¼å¼ï¼ˆSTM32 â†’ PCï¼‰

æ¯ä¸ªå‘½ä»¤å¿…é¡»è¿”å›å¯¹åº”çš„å“åº”å¸§ï¼š

| è¯·æ±‚ CMD_ID | å“åº” CMD_ID (Hex) | Payload (å“åº”æ•°æ®)        | è¯´æ˜ |
|-------------|-------------------|----------------------------|------|
| `0x0101`    | `0x0102` (`CMD_FLASH_READ_RESULT`) | `N å­—èŠ‚åŸå§‹ Flash æ•°æ®` | é•¿åº¦ = è¯·æ±‚ä¸­çš„é•¿åº¦ |
| `0x0201`    | `0x0203` (`CMD_I2C_READ_RESULT`)   | `1 å­—èŠ‚è¯»å–å€¼`          | è‹¥å¤±è´¥ï¼Œå¯è¿”å›ç©ºå¸§æˆ–é”™è¯¯ç  |
| `0x0202`    | `0x0204` (`CMD_I2C_WRITE_ACK`)     | ï¼ˆå¯é€‰ï¼šæ—  payloadï¼‰    | è¡¨ç¤ºå†™å…¥æˆåŠŸ |
| `0x0301`    | `0x0303` (`CMD_SPI_READ_RESULT`)   | `1 å­—èŠ‚è¯»å–å€¼`          | â€”â€” |
| `0x0302`    | `0x0304` (`CMD_SPI_WRITE_ACK`)     | ï¼ˆå¯é€‰ï¼‰                | â€”â€” |

> âš ï¸ **è¶…æ—¶å¤„ç†**ï¼šè‹¥ STM32 æ— æ³•å“åº”ï¼ˆå¦‚ I2C è®¾å¤‡æ— åº”ç­”ï¼‰ï¼Œ**ä»éœ€è¿”å›ä¸€ä¸ªæœ‰æ•ˆ HDLC å¸§**ï¼ˆå¦‚ç©º payload æˆ–é”™è¯¯ç ï¼‰ï¼Œå¦åˆ™ PC ä¼šåˆ¤å®šâ€œè®¾å¤‡æ–­å¼€â€ã€‚

---

## å››ã€é€šä¿¡æµç¨‹å›¾

```mermaid
sequenceDiagram
    participant PC as PC Tool
    participant STM32 as STM32 Device

    PC->>STM32: HDLC Frame (CMD_ID + Payload)
    activate STM32
    STM32-->>STM32: è§£æå‘½ä»¤ï¼Œæ‰§è¡Œæ“ä½œ
    alt æ“ä½œæˆåŠŸ
        STM32->>PC: HDLC Frame (RESP_CMD_ID + Result)
    else æ“ä½œå¤±è´¥ï¼ˆå¦‚I2C NACKï¼‰
        STM32->>PC: HDLC Frame (RESP_CMD_ID + ç©º æˆ– é”™è¯¯ç )
    end
    deactivate STM32


